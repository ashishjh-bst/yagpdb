{{define "cp_twitch"}} {{template "cp_head" .}}
<style>
  .tw-tbl-actions-column {
      display: flex;
      flex-direction: column;
  }
  .tw-tbl-actions-column > button { 
    margin: 5px
  }
  .card-deck {
    margin: 0 !important;
  }
</style>
<header class="page-header">
    <h2>Twitch live feeds</h2>
</header>
{{template "cp_alerts" .}}
<!-- /.row -->
<div class="row">
    <div class="card-deck col-lg-12">
        <div class="card col-md-6 col-sm-12">
            <header class="card-header">
                <h2 class="card-title">Add New Feed</h2>
            </header>
            <div class="card-body">
                <form method="post" class="no-unsaved-popup" action="/manage/{{.ActiveGuild.ID}}/twitch">
                    <p>
                        <b>Enter the Twitch channel name (not the full URL)</b>
                        <br>
                        Example: <b>xqc</b>, <b>pokimane</b>, <b>shroud</b>
                        <br>
                        For any questions join the support server of the bot
                    </p>
                    <div class="form-group">
                        <label for="tw-channel-name">Twitch Channel Name</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-prepend"><span class="input-group-text"></span></span>
                            <input type="text" class="form-control" placeholder="Enter Twitch channel name" id="tw-channel-name" name="TwitchChannelName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="channel">Discord Channel</label>
                        <select id="channel" class="form-control" name="DiscordChannel" data-requireperms-send>
                            {{textChannelOptions .ActiveGuild.Channels nil false ""}}
                        </select>
                    </div>
                    <div class="custom-announcement-disables">
                        <span class="custom-announcement-popover">
                            {{checkbox "MentionEveryone" "new-mention-everyone" `Mention Everyone` false}}
                        </span>
                    </div>
                    <div class="form-group custom-announcement-disables">
                        <div>
                            <span class="custom-announcement-popover">
                            <select id="roles" class="multiselect form-control" multiple="multiple" name="MentionRoles" data-plugin-multiselect>
                                {{roleOptionsMulti .ActiveGuild.Roles nil nil}}
                            </select>
                            <label for="roles">Mention Roles</label>
                            </span>
                        </div>
                    </div>
                    {{checkbox "PublishVODs" "new-publish-vods" `Publish VODs when stream ends` false}}
                </form>
            </div>
        </div>
        <div class="card col-md-6 col-sm-12">
            <header class="card-header">
                <h2 class="card-title">Custom Announcement <span class="badge badge-warning">Premium</span></h2>
            </header>
            <div class="card-body">
                {{if not .IsGuildPremium}}
                    <div class="alert alert-warning">Custom announcements are a premium feature. <a href="/premium-perks" target="_blank">Learn more</a>.</div>
                {{end}}
                <form  method="post" action="/manage/{{.ActiveGuild.ID}}/twitch/announcement">
                  <div class="form-group col mb-0">
                        {{checkbox "Enabled" "tw-announcement-enabled" `<h2 class=\"card-title\">Enable</h2>` .Announcement.Enabled}}{{if not .IsGuildPremium}}<fieldset disabled style="opacity:0.5;">{{end}}
                        <label>Twitch Announcement Message (<span class="tw-announcement-length-counter"> {{toRune .Announcement.Message|len}}</span>/5000)</label>
                        <textarea class="form-control" rows="10" id="tw-announcement-msg" name="Message" oninput="OnAnnouncementChange(this)">{{.Announcement.Message}}</textarea>
                        <span style="display: block;">
                          <button type="submit" id="tw-save-announcement-btn" class="btn btn-sm btn-success btn-block" data-async-form-alertsonly>Save</button>
                        </span>{{if not .IsGuildPremium}}</fieldset>{{end}}
                        <p class="help-block">
                          <b>Note: using Custom Announcement will override the default notification message. You can use template variables like <code>{{"{{.TwitchChannelName}}"}}</code>, <code>{{"{{.StreamTitle}}"}}</code>, <code>{{"{{.URL}}"}}</code>, etc.</b>
                        </p>
                    </div>
                </form>
                <hr/>
                {{if not .IsGuildPremium}}
                   <fieldset disabled style="opacity:0.5;">
                {{end}}
                <div class="form-group col mb-0">
                    {{checkbox "VODAnnouncementEnabled" "tw-vod-announcement-enabled" `<h2 class=\"card-title\">Enable VOD Custom Announcement</h2>` .Announcement.VODAnnouncementEnabled}}
                    <label>Twitch VOD Announcement Message (<span class="tw-announcement-length-counter"> {{toRune .Announcement.VODAnnouncement|len}}</span>/5000)</label>
                    <textarea class="form-control" rows="5" id="tw-vod-announcement-msg" name="VODAnnouncement" oninput="OnAnnouncementChange(this)">{{.Announcement.VODAnnouncement}}</textarea>
                    <span style="display: block;">
                      <button type="submit" id="tw-save-vod-announcement-btn" class="btn btn-sm btn-success btn-block" data-async-form-alertsonly>Save</button>
                    </span>
                    <p class="help-block">
                      <b>Note: using VOD Custom Announcement will override the default VOD notification message. You can use template variables like <code>{{"{{.TwitchChannelName}}"}}</code>, <code>{{"{{.DurationAgo}}"}}</code>, <code>{{"{{.VODURL}}"}}</code>, etc.</b>
                    </p>
                </div>
                {{if not .IsGuildPremium}}</fieldset>{{end}}
            </div>
        </div>
        <!-- /.card -->
    </div>
    <div class="card-deck col-lg-12">
      <section class="card">
        <header class="card-header">
            <h2 class="card-title">Current subscribed channels</h2>
        </header>
        <div class="card-body">
            {{$dot := .}} {{range .Subs}}
            <form id="sub-item-{{.ID}}" data-async-form method="post" action="/manage/{{$dot.ActiveGuild.ID}}/twitch/{{.ID}}/update"><input type="text" class="hidden form-control" name="id" value="{{.ID}}"></form>{{end}}
            <table class="table table-responsive-md table-sm mb-0">
                <thead>
                    <tr>
                        <th>Twitch</th>
                        <th>Discord Channel</th>
                        <th>Mention Everyone</th>
                        <th>Mention Roles</th>
                        <th>Publish VODs</th>
                        <th>Custom Notification</th>
                        <th>Enabled</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody class="tw-tbl-body">
                    {{range .Subs}}
                    <tr class="tw-tbl-row">
                        <td class="tw-tbl-column">
                            <p class="form-control-static"><a class="feedlink" href="https://twitch.tv/{{.TwitchChannelName}}" target="_blank"><b>{{.TwitchChannelName}}</b></a> - <code>{{.TwitchChannelID}}</code></p>
                        </td>
                        <td class="tw-tbl-column">
                            <select form="sub-item-{{.ID}}" id="channel" class="form-control" name="DiscordChannel" data-requireperms-embed>
                                {{textChannelOptions $dot.ActiveGuild.Channels .ChannelID false ""}}
                            </select>
                        </td>
                        <td class="tw-tbl-column custom-announcement-disables">
                            <span class="custom-announcement-popover">
                            {{checkbox "MentionEveryone" (print "mention-everyone-" .ID) `Mention everyone` .MentionEveryone (print `form="sub-item-` .ID `"`)}}
                            </span>
                        </td>
                        <td class="tw-tbl-column custom-announcement-disables">
                            <span class="custom-announcement-popover">
                            <select form="sub-item-{{.ID}}" name="MentionRoles" class="multiselect form-control" multiple="multiple"
                              id="mention-roles" data-plugin-multiselect>
                              {{roleOptionsMulti $dot.ActiveGuild.Roles nil .MentionRoles }}
                            </select>
                            </span>
                        </td>
                        <td class="tw-tbl-column">
                            {{checkbox "PublishVODs" (print "publish-vods-" .ID) `Publish VODs` .PublishVODs (print `form="sub-item-` .ID `"`)}}
                        </td>
                        <td class="tw-tbl-column">
                            {{if .CustomMessageEnabled}}
                                <span class="badge badge-warning">Premium</span>
                                <pre style="white-space:pre-wrap">{{.CustomMessage}}</pre>
                            {{else}}
                                <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td class="tw-tbl-column">
                            {{checkbox "Enabled" (print "feed-enabled-" .ID) `` .Enabled (print `form="sub-item-` .ID `"`)}}
                        </td>
                        <td class="tw-tbl-column tw-tbl-actions-column">
                            <button form="sub-item-{{.ID}}" type="submit" class="btn btn-success" formaction="/manage/{{$dot.ActiveGuild.ID}}/twitch/{{.ID}}/update" data-async-form-alertsonly>Save</button>
                            <button form="sub-item-{{.ID}}" type="submit" class="btn btn-danger" formaction="/manage/{{$dot.ActiveGuild.ID}}/twitch/{{.ID}}/delete">Delete</button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
      </section>
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<script>
    // Optionally add JS for validation, similar to YouTube page
</script>
{{template "cp_footer" .}}
{{end}} 